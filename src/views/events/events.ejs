<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %> · Ella Rises</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet"/>
</head>

<body>
    <%- include('../../partials/header') %>

    <div class="container">

        <!-- PAGE HEADER -->
        <div class="page-header d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">Events</h1>
                <p class="page-subtitle">Program events and workshops empowering young women</p>
            </div>

            <% if (user && user.userRole === "admin") { %>
                <a href="/eventEdit" class="btn btn-primary btn-sm-pill">
                    + Add Event
                </a>
            <% } %>
        </div>

        <div class="data-card">

            <!-- SEARCH BAR -->
            <div class="search-row">
                <form action="/events" method="GET" class="d-flex w-100" style="gap: 10px;">
                    <input
                        type="text"
                        name="search"
                        class="form-control"
                        placeholder="Search by event name or location"
                        value="<%= typeof search !== 'undefined' ? search : '' %>"
                    >

                    <button class="btn btn-outline-primary btn-sm-pill" type="submit">Search</button>

                    <a href="/events" class="btn btn-secondary btn-sm-pill">Clear</a>
                </form>
            </div>

            <!-- EVENTS TABLE -->
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th></th> <!-- View -->
                            <% if (user && user.userRole === "admin") { %>
                                <th></th> <!-- Edit -->
                                <th></th> <!-- Delete -->
                            <% } %>
                        </tr>
                    </thead>
                    
                    <tbody>
                        <% if (events && events.length > 0) { %>
                            <% events.forEach(ev => { %>
                                <tr>
                                    <td><%= ev.eventname %></td>
                    
                                    <td>
                                        <%= new Date(ev.eventdatetimestart).toLocaleString() %>
                                    </td>
                    
                                    <td><%= ev.eventlocation %></td>
                    
                                    <!-- VIEW BUTTON (admins AND participants) -->
                                    <td>
                                        <form action="/registration/<%= ev.eventid %>" method="GET">
                                            <button class="btn btn-outline-primary btn-sm-pill" type="submit">
                                                View
                                            </button>
                                        </form>
                                    </td>
                    
                                    <!-- EDIT BUTTON (admins only) -->
                                    <% if (user && user.userRole === "admin") { %>
                                    <td>
                                        <a href="/eventEdit/<%= ev.eventid %>" 
                                           class="btn btn-outline-primary btn-sm-pill">
                                            Edit
                                        </a>
                                    </td>
                                    <% } %>
                    
                                    <!-- DELETE BUTTON (admins only) -->
                                    <% if (user && user.userRole === "admin") { %>
                                    <td>
                                        <form action="/deleteEvent/<%= ev.eventid %>"
                                              method="POST"
                                              onsubmit="return confirm('Are you sure you want to delete this event?');">
                                            <button class="btn btn-outline-primary btn-sm-pill" type="submit">
                                                Delete
                                            </button>
                                        </form>
                                    </td>
                                    <% } %>
                                </tr>
                            <% }) %>
                    
                        <% } else { %>
                            <tr>
                                <td colspan="10" class="text-center text-muted">
                                    No events to display yet.
                                </td>
                            </tr>
                        <% } %>
                    </tbody>                    
                </table>

                <!-- PAGINATION -->
                <div class="pagination mt-3 d-flex align-items-center justify-content-center gap-2">

                    <% if (totalPages > 1) { %>

                        <!-- Previous -->
                        <a class="btn btn-outline-primary btn-sm-pill <%= currentPage === 1 ? 'disabled' : '' %>"
                            href="<%= currentPage > 1 ? `/events?page=${currentPage - 1}&search=${search}` : '#' %>">
                            ← Prev
                        </a>

                        <% 
                            const startPage = Math.max(1, currentPage - 2);
                            const endPage = Math.min(totalPages, currentPage + 2);
                        %>

                        <!-- Page numbers -->
                        <% for (let i = startPage; i <= endPage; i++) { %>
                            <a class="btn btn-sm-pill <%= i === currentPage ? 'btn-primary' : 'btn-outline-primary' %>"
                                href="/events?page=<%= i %>&search=<%= search %>">
                                <%= i %>
                            </a>
                        <% } %>

                        <!-- Next -->
                        <a class="btn btn-outline-primary btn-sm-pill <%= currentPage === totalPages ? 'disabled' : '' %>"
                            href="<%= currentPage < totalPages ? `/events?page=${currentPage + 1}&search=${search}` : '#' %>">
                            Next →
                        </a>

                    <% } %>

                </div>
            </div>
        </div>

        <div class="footer">
            &copy; <%= new Date().getFullYear() %> Ella Rises · Events
        </div>
    </div>
</body>
</html>

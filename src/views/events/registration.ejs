<!-- This page should only be available to logged-in users. -->
<!-- The "register" button should only be displayed if the registration deadline is in the future. -->
<!-- The "register" button should be changed to "unregister" if the logged-in user ID is in the registration table for this event, and the event has not concluded. -->
<!-- The "register" button should be changed "Submit Survey" if the logged-in user ID is in the registration table for the event, the event has concluded, and the user's instance of registration lists them as having attended. -->
<!-- If none of the above are true, the button should not be displayed. -->
<!-- Optional: an admin-only button that displays surveys for this event. Can be visible at any time. -->
<!-- This page should show a list of those registered to attend the event. -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %> · Ella Rises</title>
  
    <!-- Font Fix -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link 
      href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Montserrat:wght@300;400;500;600;700&display=swap" 
      rel="stylesheet"
    >
  
    <!-- Bootstrap + Site Styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet" />
  </head>
  

<body>
  <%- include('../../partials/header') %>

  <div class="container">

    <!-- PAGE HEADER -->
    <div class="page-header">
      <h1 class="page-title"><%= event.eventname %></h1>
      <p class="page-subtitle"><%= event.eventdescription %></p>
    </div>

    <!-- ========= EVENT DETAILS CARD ========= -->
    <div class="data-card mb-4">

      <!-- Event Info -->
      <p><strong>Date:</strong>
        <%= new Date(event.eventdatetimestart).toLocaleString() %> –
        <%= new Date(event.eventdatetimeend).toLocaleString() %>
      </p>

      <p><strong>Location:</strong> <%= event.eventlocation %></p>

      <!-- ACTION BUTTONS -->
      <div class="d-flex flex-wrap gap-2 mt-3">

        <% if (showRegisterBtn) { %>
          <form action="/register/<%= event.eventid %>" method="POST">
            <button type="submit" class="btn btn-primary btn-sm-pill">
              Register
            </button>
          </form>
        <% } %>

        <% if (showCancelBtn) { %>
          <form action="/cancel/<%= event.eventid %>" method="POST">
            <button type="submit" class="btn btn-outline-primary btn-sm-pill">
              Cancel Registration
            </button>
          </form>
        <% } %>

        <% if (showTakeSurvey) { %>
          <a href="/surveyForm/<%= event.eventid %>" class="btn btn-outline-primary btn-sm-pill">
            Take Survey
          </a>
        <% } %>

        <% if (surveySubmitted) { %>
          <span class="text-success ms-2">Survey Submitted</span>
        <% } %>

        <!-- ADMIN ACTIONS -->
        <% if (userRole === "admin") { %>

          <% const anySignedUp = participants.some(p => p.registrationstatus === 'signedup'); %>
          <% const anyAttended = participants.some(p => p.registrationstatus === 'attended'); %>

          <% if (eventEnded && anySignedUp) { %>
            <form method="POST" action="/endEvent/<%= event.eventid %>"
                  onsubmit="return confirm('Are you sure you want to end this event? All signed-up participants will be marked no-show.');">
              <button type="submit" class="btn btn-danger btn-sm-pill">End Event</button>
            </form>
          <% } %>

          <% if (anyAttended) { %>
            <a href="/surveys?eventid=<%= event.eventid %>" class="btn btn-outline-primary btn-sm-pill">
              View All Surveys
            </a>
          <% } %>

          <a href="/eventEdit/<%= event.eventid %>" class="btn btn-secondary btn-sm-pill">
            Edit Event
          </a>

        <% } %>
      </div>
    </div>

    <!-- ========= PARTICIPANTS CARD ========= -->
    <div class="data-card">

      <h4 class="mb-3">Participants</h4>

      <% if (participants && participants.length > 0) { %>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Status</th>
                <th>Check-In Time</th>
                <th>Registered At</th>
                <% if (userRole === 'admin') { %>
                  <th>Actions</th>
                  <th>Survey</th>
                <% } %>
              </tr>
            </thead>

            <tbody>
              <% participants
                .sort((a, b) => {
                  const order = { signedup: 1, attended: 2, cancelled: 3, 'no-show': 4 };
                  return order[a.registrationstatus] - order[b.registrationstatus]
                    || a.memberlastname.localeCompare(b.memberlastname)
                    || a.memberfirstname.localeCompare(b.memberfirstname);
                })
                .forEach(p => {
                  let checkInText = "";
                  let confirmMessage = "";

                  if (p.registrationstatus === 'attended') {
                    checkInText = 'Check Out';
                    confirmMessage = `Are you sure you want to check out ${p.memberfirstname} ${p.memberlastname}?`;
                  } else if (p.registrationstatus !== 'signedup') {
                    checkInText = 'Check In';
                    confirmMessage = `Are you sure you want to check in someone with the status of ${p.registrationstatus}?`;
                  } else {
                    checkInText = 'Check In';
                    confirmMessage = 'Confirm check-in?';
                  }
              %>

                <tr>
                  <td><%= p.memberfirstname %></td>
                  <td><%= p.memberlastname %></td>
                  <td><%= p.registrationstatus %></td>
                  <td><%= p.registrationcheckintime ? new Date(p.registrationcheckintime).toLocaleString() : '-' %></td>
                  <td><%= p.registrationcreatedat ? new Date(p.registrationcreatedat).toLocaleString() : '-' %></td>

                  <% if (userRole === 'admin') { %>
                    <td>
                      <% if (!eventEnded) { %>
                        <form method="POST" action="/checkin/<%= p.peid %>"
                              onsubmit="return confirm('<%= confirmMessage %>');">
                          <button type="submit" class="btn btn-outline-primary btn-sm-pill">
                            <%= checkInText %>
                          </button>
                        </form>
                      <% } else { %>
                        <span class="text-muted">Event Ended</span>
                      <% } %>
                    </td>

                    <td>
                      <% if (p.registrationstatus === 'attended' && p.hasSurvey) { %>
                        <a href="/surveys/<%= p.peid %>" class="btn btn-outline-primary btn-sm-pill">
                          View Survey
                        </a>
                      <% } else { %>
                        <span>-</span>
                      <% } %>
                    </td>
                  <% } %>

                </tr>

              <% }) %>
            </tbody>
          </table>
        </div>

      <% } else { %>
        <p class="text-muted">No participants to display yet.</p>
      <% } %>

    </div>

    <div class="footer">
      &copy; <%= new Date().getFullYear() %> Ella Rises · Events
    </div>

  </div>
</body>
</html>
